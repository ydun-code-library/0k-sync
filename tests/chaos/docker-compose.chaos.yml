# Chaos Testing Docker Compose Configuration
# Version: 2.0
#
# Topologies:
# - Pair: 1 relay, 2 clients (default)
# - Swarm: 1 relay, N clients (for resource exhaustion tests)
#
# NOTE: Toxiproxy only supports TCP. The iroh QUIC transport uses UDP,
# so toxiproxy cannot inject chaos into the QUIC path. The HTTP
# health/metrics endpoint (port 8080) can still be chaosed via TCP.
# Network chaos on QUIC uses `tc netem` via docker exec (NET_ADMIN).

services:
  # Toxiproxy for HTTP endpoint chaos injection (TCP only)
  toxiproxy:
    image: ghcr.io/shopify/toxiproxy:latest
    ports:
      - "8474:8474"   # API port
      - "19000:19000" # Relay proxy port (TCP only)
    networks:
      - chaos-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8474/version"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Sync relay server
  relay:
    build:
      context: ../..
      dockerfile: tests/chaos/Dockerfile.relay
    ports:
      - "8080:8080"
    stop_signal: SIGINT
    cap_add:
      - NET_ADMIN
    networks:
      - chaos-net
    volumes:
      - relay-data:/data
    depends_on:
      toxiproxy:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Client A — stays alive via sleep infinity, controlled via docker exec
  client-a:
    build:
      context: ../..
      dockerfile: tests/chaos/Dockerfile.cli
    cap_add:
      - NET_ADMIN
    networks:
      - chaos-net
    depends_on:
      relay:
        condition: service_healthy
    environment:
      - CLIENT_NAME=client-a
      - DATA_DIR=/data
    volumes:
      - client-a-data:/data
    command: ["sleep", "infinity"]

  # Client B — stays alive via sleep infinity, controlled via docker exec
  client-b:
    build:
      context: ../..
      dockerfile: tests/chaos/Dockerfile.cli
    cap_add:
      - NET_ADMIN
    networks:
      - chaos-net
    depends_on:
      relay:
        condition: service_healthy
    environment:
      - CLIENT_NAME=client-b
      - DATA_DIR=/data
    volumes:
      - client-b-data:/data
    command: ["sleep", "infinity"]

networks:
  chaos-net:
    driver: bridge
    internal: true  # Isolated from external network

volumes:
  relay-data:
  client-a-data:
  client-b-data:
